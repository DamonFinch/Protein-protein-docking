
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>deeprank.tools.pdb2sql &#8212; DeepRank 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">DeepRank 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for deeprank.tools.pdb2sql</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>



<div class="viewcode-block" id="pdb2sql"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql">[docs]</a><span class="k">class</span> <span class="nc">pdb2sql</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pdbfile</span><span class="p">,</span><span class="n">sqlfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fix_chainID</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a SQL data base for a PDB file.</span>

<span class="sd">        This allows to easily parse and extract information of the PDB using SQL queries.</span>

<span class="sd">        Args:</span>
<span class="sd">            pdbfile (str or list(bytes)) : the pdb information can be provided as filename of list of bytes containign the pdb data</span>
<span class="sd">            sqlfile (str, optional): name of the sqlfile. By default it is created in memory only</span>
<span class="sd">            fix_chainID (bool, optinal): check if the name of the chains are A,B,C, .... and fix it if not</span>
<span class="sd">            verbose (bool): probably print stuff.</span>

<span class="sd">        Example:</span>

<span class="sd">        &gt;&gt;&gt; # create the sql</span>
<span class="sd">        &gt;&gt;&gt; db = pdb2sql(&#39;1AK4_100w.pdb&#39;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # print the database</span>
<span class="sd">        &gt;&gt;&gt; db.prettyprint()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # get the names of the columns</span>
<span class="sd">        &gt;&gt;&gt; db.get_colnames()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # extract the xyz position of the atoms with name CB</span>
<span class="sd">        &gt;&gt;&gt; xyz = db.get(&#39;*&#39;,index=[0,1,2,3])</span>
<span class="sd">        &gt;&gt;&gt; print(xyz)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; xyz = db.get(&#39;rowID&#39;,where=&quot;resName=&#39;VAL&#39;&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(xyz)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; db.add_column(&#39;CHARGE&#39;,&#39;FLOAT&#39;)</span>
<span class="sd">        &gt;&gt;&gt; db.put(&#39;CHARGE&#39;,0.1)</span>
<span class="sd">        &gt;&gt;&gt; db.prettyprint()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; db.exportpdb(&#39;chainA.pdb&#39;,where=&quot;chainID=&#39;A&#39;&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # close the database</span>
<span class="sd">        &gt;&gt;&gt; db.close()</span>


<span class="sd">            Other queries have been made user friendly</span>

<span class="sd">            - self.add_column(column_name,coltype=&#39;FLOAT&#39;,default=0)</span>
<span class="sd">            - self.update_column(colname,values,index=None)</span>
<span class="sd">            - self.update_xyz(new_xyz,index=None)</span>
<span class="sd">            - self.commit()</span>

<span class="sd">            TO DO</span>

<span class="sd">            - Add more user friendly wrappers to SQL queries</span>
<span class="sd">            - Make use of the ? more often to prevent quoting issues and SQL injection attack</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span> <span class="o">=</span> <span class="n">pdbfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlfile</span> <span class="o">=</span> <span class="n">sqlfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="c1"># create the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_sql</span><span class="p">()</span>


        <span class="c1"># fix the chain ID</span>
        <span class="k">if</span> <span class="n">fix_chainID</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fix_chainID</span><span class="p">()</span>

        <span class="c1"># backbone type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backbone_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;CA&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">]</span>

        <span class="c1"># hard limit for the number of SQL varaibles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SQLITE_LIMIT_VARIABLE_NUMBER</span> <span class="o">=</span> <span class="mi">999</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_sql_values</span> <span class="o">=</span> <span class="mi">950</span>



    <span class="c1">##################################################################################</span>
    <span class="c1">#</span>
    <span class="c1">#   CREATION AND PRINTING</span>
    <span class="c1">#</span>
    <span class="c1">##################################################################################</span>

    <span class="k">def</span> <span class="nf">_create_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the sql database.&quot;&quot;&quot;</span>

        <span class="n">pdbfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span>
        <span class="n">sqlfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlfile</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- Create SQLite3 database&#39;</span><span class="p">)</span>

        <span class="c1">#name of the table</span>
        <span class="c1">#table = &#39;ATOM&#39;</span>

        <span class="c1"># column names and types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;serial&#39;</span> <span class="p">:</span> <span class="s1">&#39;INT&#39;</span><span class="p">,</span>
               <span class="s1">&#39;name&#39;</span>   <span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
               <span class="s1">&#39;altLoc&#39;</span> <span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
               <span class="s1">&#39;resName&#39;</span> <span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
               <span class="s1">&#39;chainID&#39;</span> <span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
               <span class="s1">&#39;resSeq&#39;</span>  <span class="p">:</span> <span class="s1">&#39;INT&#39;</span><span class="p">,</span>
               <span class="s1">&#39;iCode&#39;</span>   <span class="p">:</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">,</span>
               <span class="s1">&#39;x&#39;</span>       <span class="p">:</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;y&#39;</span>       <span class="p">:</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;z&#39;</span>       <span class="p">:</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;occ&#39;</span>     <span class="p">:</span> <span class="s1">&#39;REAL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;temp&#39;</span>    <span class="p">:</span> <span class="s1">&#39;REAL&#39;</span><span class="p">}</span>

        <span class="c1"># delimtier of the column format</span>
        <span class="c1"># taken from http://www.wwpdb.org/documentation/file-format-content/format33/sect9.html#ATOM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;serial&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">11</span><span class="p">],</span>
                    <span class="s1">&#39;name&#39;</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="mi">16</span><span class="p">],</span>
                    <span class="s1">&#39;altLoc&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">17</span><span class="p">],</span>
                    <span class="s1">&#39;resName&#39;</span> <span class="p">:[</span><span class="mi">17</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span>
                    <span class="s1">&#39;chainID&#39;</span> <span class="p">:[</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">],</span>
                    <span class="s1">&#39;resSeq&#39;</span>  <span class="p">:[</span><span class="mi">22</span><span class="p">,</span><span class="mi">26</span><span class="p">],</span>
                    <span class="s1">&#39;iCode&#39;</span>   <span class="p">:[</span><span class="mi">26</span><span class="p">,</span><span class="mi">26</span><span class="p">],</span>
                    <span class="s1">&#39;x&#39;</span>       <span class="p">:[</span><span class="mi">30</span><span class="p">,</span><span class="mi">38</span><span class="p">],</span>
                    <span class="s1">&#39;y&#39;</span>       <span class="p">:[</span><span class="mi">38</span><span class="p">,</span><span class="mi">46</span><span class="p">],</span>
                    <span class="s1">&#39;z&#39;</span>       <span class="p">:[</span><span class="mi">46</span><span class="p">,</span><span class="mi">54</span><span class="p">],</span>
                    <span class="s1">&#39;occ&#39;</span>     <span class="p">:[</span><span class="mi">54</span><span class="p">,</span><span class="mi">60</span><span class="p">],</span>
                    <span class="s1">&#39;temp&#39;</span>    <span class="p">:[</span><span class="mi">60</span><span class="p">,</span><span class="mi">66</span><span class="p">]}</span>

        <span class="c1"># size of the things</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
        <span class="n">ndel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">)</span>


        <span class="c1"># open the data base</span>
        <span class="c1"># if we do not specify a db name</span>
        <span class="c1"># the db is only in RAM</span>
        <span class="c1"># there might be little advantage to use memory</span>
        <span class="c1"># https://stackoverflow.com/questions/764710/sqlite-performance-benchmark-why-is-memory-so-slow-only-1-5x-as-fast-as-d</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;:memory:&#39;</span><span class="p">)</span>
        <span class="c1"># or we create a new db file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">sqlfile</span><span class="p">):</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">sqlfile</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sqlfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># intialize the header/placeholder</span>
        <span class="n">header</span><span class="p">,</span><span class="n">qm</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">ic</span><span class="p">,(</span><span class="n">colname</span><span class="p">,</span><span class="n">coltype</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{cn}</span><span class="s1"> </span><span class="si">{ct}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">colname</span><span class="p">,</span><span class="n">ct</span><span class="o">=</span><span class="n">coltype</span><span class="p">)</span>
            <span class="n">qm</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span>
            <span class="k">if</span> <span class="n">ic</span> <span class="o">&lt;</span> <span class="n">ncol</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span>
                <span class="n">qm</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span>

        <span class="c1"># create the table</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE ATOM (</span><span class="si">{hd}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hd</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>


        <span class="c1"># read the pdb file</span>
        <span class="c1"># this is dangerous if there are ATOM written in the comment part</span>
        <span class="c1"># which happends often</span>
        <span class="c1">#data = sp.check_output(&quot;awk &#39;/ATOM/&#39; %s&quot; %pdbfile,shell=True).decode(&#39;utf8&#39;).split(&#39;\n&#39;)</span>

        <span class="c1"># a safer version consist at matching against the first field</span>
        <span class="c1"># won&#39;t work on windows</span>
        <span class="c1">#data = sp.check_output(&quot;awk &#39;$1 ~ /^ATOM/&#39; %s&quot; %pdbfile,shell=True).decode(&#39;utf8&#39;).split(&#39;\n&#39;)</span>

        <span class="c1"># a pure python way</span>
        <span class="c1"># RMK we go through the data twice here. Once to read the ATOM line and once to parse the data ...</span>
        <span class="c1"># we could do better than that. But the most time consuming step seems to be the CREATE TABLE query</span>
        <span class="c1"># if we path a file we read it</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fi</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fi</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> was not found&#39;</span><span class="p">,</span><span class="n">pdbfile</span><span class="p">)</span>

        <span class="c1"># if we pass a list as for h5py read/write</span>
        <span class="c1"># we directly use that</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span>  <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">pdbfile</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

        <span class="c1"># if we cant read it</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pdbfile</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;PDB data not recognized&#39;</span><span class="p">)</span>

        <span class="c1"># if there is no ATOM in the file</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- Error : No ATOM in the pdb file.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>

        <span class="c1"># haddock chain ID fix</span>
        <span class="n">del_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">del_copy</span><span class="p">[</span><span class="s1">&#39;chainID&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
            <span class="n">del_copy</span><span class="p">[</span><span class="s1">&#39;chainID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">72</span><span class="p">,</span><span class="mi">73</span><span class="p">]</span>

        <span class="c1"># get all the data</span>
        <span class="n">data_atom</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iatom</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>

            <span class="c1"># sometimes we still have an empty line somewhere</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># browse all attribute of each atom</span>
            <span class="n">at</span> <span class="o">=</span> <span class="p">()</span>
            <span class="k">for</span> <span class="n">ik</span><span class="p">,(</span><span class="n">colname</span><span class="p">,</span><span class="n">coltype</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

                <span class="c1"># get the piece of data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">del_copy</span><span class="p">[</span><span class="n">colname</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">del_copy</span><span class="p">[</span><span class="n">colname</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="c1"># convert it if necessary</span>
                <span class="k">if</span> <span class="n">coltype</span> <span class="o">==</span> <span class="s1">&#39;INT&#39;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">coltype</span> <span class="o">==</span> <span class="s1">&#39;REAL&#39;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                <span class="c1"># append keep the comma !!</span>
                <span class="c1"># we need proper tuple</span>
                <span class="n">at</span> <span class="o">+=</span><span class="p">(</span><span class="n">data</span><span class="p">,)</span>

            <span class="c1"># append</span>
            <span class="n">data_atom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>


        <span class="c1"># push in the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s1">&#39;INSERT INTO ATOM VALUES (</span><span class="si">{qm}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qm</span><span class="o">=</span><span class="n">qm</span><span class="p">),</span><span class="n">data_atom</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_fix_chainID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fix the chain ID if necessary.</span>

<span class="sd">        Replace the chain ID by A,B,C,D, ..... in that order</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">string</span> <span class="k">import</span> <span class="n">ascii_uppercase</span>

        <span class="c1"># get the current names</span>
        <span class="n">chainID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainID&#39;</span><span class="p">)</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chainID</span><span class="p">)</span>
        <span class="n">chainID</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">chainID</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chainID</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">26</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning more than 26 chains have been detected. This is so far not supported&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="c1"># declare the new names</span>
        <span class="n">newID</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">natom</span>

        <span class="c1"># fill in the new names</span>
        <span class="k">for</span> <span class="n">ic</span><span class="p">,</span><span class="n">chain</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chainID</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chain</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
                <span class="n">newID</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ascii_uppercase</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>

        <span class="c1"># update the new name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_column</span><span class="p">(</span><span class="s1">&#39;chainID&#39;</span><span class="p">,</span><span class="n">newID</span><span class="p">)</span>


    <span class="c1"># get the names of the columns</span>
<div class="viewcode-block" id="pdb2sql.get_colnames"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.get_colnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_colnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from atom&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Possible column names are:&#39;</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cd</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">rowID&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">n</span><span class="p">)</span></div>

    <span class="c1"># print the database</span>
<div class="viewcode-block" id="pdb2sql.prettyprint"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.prettyprint">[docs]</a>    <span class="k">def</span> <span class="nf">prettyprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">pandas.io.sql</span> <span class="k">as</span> <span class="nn">psql</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">psql</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM ATOM&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>

<div class="viewcode-block" id="pdb2sql.uglyprint"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.uglyprint">[docs]</a>    <span class="k">def</span> <span class="nf">uglyprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">ctmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM ATOM&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ctmp</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span></div>


    <span class="c1">############################################################################################</span>
    <span class="c1">#</span>
    <span class="c1">#       GET FUNCTIONS</span>
    <span class="c1">#</span>
    <span class="c1">#           get(attribute,selection) -&gt; return the atribute(s) value(s) for the given selection</span>
    <span class="c1">#           get_contact_atoms()      -&gt; return a list of rowID  for the contact atoms</span>
    <span class="c1">#           get_contact_residue()    -&gt; return a list of resSeq for the contact residue</span>
    <span class="c1">#</span>
    <span class="c1">###############################################################################################</span>


<div class="viewcode-block" id="pdb2sql.get"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">atnames</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Get data from the sql database.</span>

<span class="sd">        Exectute a simple SQL query that extracts values of attributes for certain conditions.</span>

<span class="sd">        Args:</span>

<span class="sd">            atnames (str): attribute name. They can be printed can get these names via the get_colnames()</span>
<span class="sd">                           serial, name, atLoc,resName,chainID, resSeq,iCode,x,y,z,occ,temp</span>
<span class="sd">                           Several attributes can be specified at once e.g &#39;x,y,z&#39;</span>

<span class="sd">            kwargs : Several options are possible</span>
<span class="sd">                     None : return the entire table</span>
<span class="sd">                     chain = &#39;X&#39; return the values of that chain</span>
<span class="sd">                     name  = &#39;CA&#39; only these atoms</span>
<span class="sd">                     index = [0,1,2,3] return only those rows (not serial)</span>
<span class="sd">                     where = &quot;chainID=&#39;B&#39;&quot; general WHERE SQL query</span>
<span class="sd">                     query = &#39;WHERE chainID=&#39;B&#39;&#39; general SQL Query</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array: data extracted from the pdb file</span>

<span class="sd">        Example :</span>

<span class="sd">        &gt;&gt;&gt; db = pdb2sql(filename)</span>
<span class="sd">        &gt;&gt;&gt; xyz  = db.get(&#39;x,y,z&#39;,index=[0,1,2,3])</span>
<span class="sd">        &gt;&gt;&gt; name = db.get(&#39;name&#39;,where=&quot;resName=&#39;VAL&#39;&quot;)</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># the asked keys</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># check if the column exists</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT EXISTS(SELECT </span><span class="si">{an}</span><span class="s2"> FROM ATOM)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">an</span><span class="o">=</span><span class="n">atnames</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error column </span><span class="si">%s</span><span class="s1"> not found in the database&#39;</span> <span class="o">%</span><span class="n">atnames</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># if we have 0 key we take the entire db</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT </span><span class="si">{an}</span><span class="s1"> FROM ATOM&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">an</span><span class="o">=</span><span class="n">atnames</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>

        <span class="c1">############################################################################</span>
        <span class="c1"># GENERIC QUERY</span>
        <span class="c1">#</span>
        <span class="c1"># the only one we need</span>
        <span class="c1"># each keys must be a valid columns</span>
        <span class="c1"># each value may be a single value or an array</span>
        <span class="c1"># AND is assumed between different keys</span>
        <span class="c1"># OR is assumed for the different values of a given key</span>
        <span class="c1">#</span>
        <span class="c1">##############################################################################</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># check that all the keys exists</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT EXISTS(SELECT </span><span class="si">{an}</span><span class="s2"> FROM ATOM)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">an</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error column </span><span class="si">%s</span><span class="s1"> not found in the database&#39;</span> <span class="o">%</span><span class="n">k</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>
                    <span class="k">return</span>

            <span class="c1"># form the query and the tuple value</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT </span><span class="si">{an}</span><span class="s1"> FROM ATOM WHERE &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">an</span><span class="o">=</span><span class="n">atnames</span><span class="p">)</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">()</span>

            <span class="c1"># iterate through the kwargs</span>
            <span class="k">for</span> <span class="n">ik</span><span class="p">,(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

                <span class="c1"># get if we have an array or a scalar</span>
                <span class="c1"># and build the value tuple for the sql query</span>
                <span class="c1"># deal with the indexing issue if rowID is required</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>

                    <span class="n">nv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

                    <span class="c1"># if we have a large number of values</span>
                    <span class="c1"># we must cut that in pieces because SQL has a hard limit</span>
                    <span class="c1"># that is 999. The limit is here set to 950</span>
                    <span class="c1"># so that we can have multiple conditions with a total number</span>
                    <span class="c1"># of values inferior to 999</span>
                    <span class="k">if</span> <span class="n">nv</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">max_sql_values</span><span class="p">:</span>

                        <span class="c1"># cut in chunck</span>
                        <span class="n">chunck_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sql_values</span>
                        <span class="n">vchunck</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunck_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nv</span><span class="p">,</span><span class="n">chunck_size</span><span class="p">)]</span>

                        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vchunck</span><span class="p">:</span>
                            <span class="n">new_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">new_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                            <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atnames</span><span class="p">,</span><span class="o">**</span><span class="n">new_kwargs</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">data</span>

                    <span class="c1">#otherwithe we just go on</span>
                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;rowID&#39;</span><span class="p">:</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">iv</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">nv</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;rowID&#39;</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="p">(</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">,)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="p">(</span><span class="n">v</span><span class="p">,)</span>

                <span class="c1"># create the condition for that key</span>
                <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39; in (&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="o">*</span><span class="n">nv</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>

            <span class="c1"># stitch the conditions and append to the query</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>

            <span class="c1"># error if vals is too long</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLITE_LIMIT_VARIABLE_NUMBER</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Error : SQL Queries can only handle a total of 999 values&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : The current query has </span><span class="si">%d</span><span class="s1"> values&#39;</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : Hence it will fails.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : You are in a rare situation where MULTIPLE conditions have&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : have a combined number of values that are too large&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : These conditions are:&#39;</span><span class="p">)</span>
                <span class="n">ntot</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : --&gt; </span><span class="si">%10s</span><span class="s1"> : </span><span class="si">%d</span><span class="s1"> values&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
                    <span class="n">ntot</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : --&gt; </span><span class="si">%10s</span><span class="s1"> : </span><span class="si">%d</span><span class="s1"> values&#39;</span> <span class="o">%</span><span class="p">(</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span><span class="n">ntot</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      : Try to decrease self.max_sql_values in pdb2sql.py</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Too many SQL variables&#39;</span><span class="p">)</span>

            <span class="c1"># query the sql database and return the answer in a list</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">vals</span><span class="p">)]</span>

        <span class="c1"># empty data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning sqldb.get returned an empty&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># fix the python &lt;--&gt; sql indexes</span>
        <span class="c1"># if atnames == &#39;rowID&#39;:</span>
        <span class="k">if</span> <span class="s1">&#39;rowID&#39;</span> <span class="ow">in</span> <span class="n">atnames</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">atnames</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># postporcess the output of the SQl query</span>
        <span class="c1"># flatten it if each els is of size 1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">data</span></div>

    <span class="c1">############################################################################</span>
    <span class="c1">#</span>
    <span class="c1"># get the contact atoms</span>
    <span class="c1">#</span>
    <span class="c1"># we should have a entire module called pdb2sql</span>
    <span class="c1"># with a submodule pdb2sql.interface that finds contact atoms/residues</span>
    <span class="c1"># and possbily other submodules to do other things</span>
    <span class="c1"># that will leave only the get / put methods in the main class</span>
    <span class="c1">#</span>
    <span class="c1">#############################################################################</span>
<div class="viewcode-block" id="pdb2sql.get_contact_atoms"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.get_contact_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">get_contact_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">8.5</span><span class="p">,</span><span class="n">chain1</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="n">chain2</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">,</span>
                          <span class="n">extend_to_residue</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">only_backbone_atoms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">excludeH</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">return_only_backbone_atoms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">return_contact_pairs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Get contact atoms.</span>

<span class="sd">        Args:</span>
<span class="sd">            cutoff (float): cutoff for contact atoms (default 8.5)</span>
<span class="sd">            chain1 (str): name of the first chain</span>
<span class="sd">            chain2 (str): name of the first chain</span>
<span class="sd">            extend_to_residue (bool): extend the contact atoms to entire residues</span>
<span class="sd">            only_bacbone_atoms (bool): consider only backbone atoms</span>
<span class="sd">            excludeH (bool): exclude hydrogen atoms</span>
<span class="sd">            return_only_backbone_atoms (bool): only returns backbone atoms</span>
<span class="sd">            return_contact_pairs (bool): return the contact pairs instead of contact atoms</span>


<span class="sd">        Returns:</span>
<span class="sd">            np.array: index of the contact atoms</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># xyz of the chains</span>
        <span class="n">xyz1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x,y,z&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chain1</span><span class="p">))</span>
        <span class="n">xyz2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x,y,z&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chain2</span><span class="p">))</span>

        <span class="c1"># index of b</span>
        <span class="n">index2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chain2</span><span class="p">)</span>

        <span class="c1"># resName of the chains</span>
        <span class="n">resName1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resName&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chain1</span><span class="p">))</span>
        <span class="c1">#resName2 = np.array(self.get(&#39;resName&#39;,chainID=chain2))</span>

        <span class="c1"># atomnames of the chains</span>
        <span class="n">atName1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chain1</span><span class="p">))</span>
        <span class="n">atName2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chain2</span><span class="p">))</span>


        <span class="c1"># loop through the first chain</span>
        <span class="c1"># TO DO : loop through the smallest chain instead ...</span>
        <span class="n">index_contact_1</span><span class="p">,</span><span class="n">index_contact_2</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="n">index_contact_pairs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz1</span><span class="p">):</span>

            <span class="c1"># compute the contact atoms</span>
            <span class="n">contacts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xyz2</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">cutoff</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># exclude the H if required</span>
            <span class="k">if</span> <span class="n">excludeH</span> <span class="ow">and</span> <span class="n">atName1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contacts</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="ow">not</span> <span class="n">only_backbone_atoms</span><span class="p">,</span> <span class="n">atName1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_type</span><span class="p">]):</span>

                <span class="c1"># the contact atoms</span>
                <span class="n">index_contact_1</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">index_contact_2</span> <span class="o">+=</span> <span class="p">[</span><span class="n">index2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">contacts</span> <span class="k">if</span> <span class="p">(</span> <span class="nb">any</span><span class="p">(</span> <span class="p">[</span><span class="n">atName2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_type</span><span class="p">,</span>  <span class="ow">not</span> <span class="n">only_backbone_atoms</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">excludeH</span> <span class="ow">and</span> <span class="n">atName2</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">]</span>

                <span class="c1"># the pairs</span>
                <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">index2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">contacts</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span> <span class="p">[</span><span class="n">atName2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_type</span><span class="p">,</span>  <span class="ow">not</span> <span class="n">only_backbone_atoms</span><span class="p">]</span> <span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">excludeH</span> <span class="ow">and</span> <span class="n">atName2</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;H&#39;</span><span class="p">)</span> <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">index_contact_pairs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pairs</span>

        <span class="c1"># get uniques</span>
        <span class="n">index_contact_1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">index_contact_1</span><span class="p">))</span>
        <span class="n">index_contact_2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">index_contact_2</span><span class="p">))</span>

        <span class="c1"># if no atoms were found</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_contact_1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning : No contact atoms detected in pdb2sql&#39;</span><span class="p">)</span>

        <span class="c1"># extend the list to entire residue</span>
        <span class="k">if</span> <span class="n">extend_to_residue</span><span class="p">:</span>
            <span class="n">index_contact_1</span><span class="p">,</span><span class="n">index_contact_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extend_contact_to_residue</span><span class="p">(</span><span class="n">index_contact_1</span><span class="p">,</span><span class="n">index_contact_2</span><span class="p">,</span><span class="n">only_backbone_atoms</span><span class="p">)</span>


        <span class="c1"># filter only the backbone atoms</span>
        <span class="k">if</span> <span class="n">return_only_backbone_atoms</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">only_backbone_atoms</span><span class="p">:</span>

            <span class="c1"># get all the names</span>
            <span class="c1"># there are better ways to do that !</span>
            <span class="n">atNames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

            <span class="c1"># change the index_contacts</span>
            <span class="n">index_contact_1</span> <span class="o">=</span> <span class="p">[</span>  <span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">index_contact_1</span> <span class="k">if</span> <span class="n">atNames</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_type</span> <span class="p">]</span>
            <span class="n">index_contact_2</span> <span class="o">=</span> <span class="p">[</span>  <span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">index_contact_2</span> <span class="k">if</span> <span class="n">atNames</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_type</span> <span class="p">]</span>

            <span class="c1"># change the contact pairs</span>
            <span class="n">tmp_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ind1</span><span class="p">,</span><span class="n">ind2_list</span> <span class="ow">in</span> <span class="n">index_contact_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">atNames</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_type</span><span class="p">:</span>
                    <span class="n">tmp_dict</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind2</span> <span class="k">for</span> <span class="n">ind2</span> <span class="ow">in</span> <span class="n">ind2_list</span> <span class="k">if</span> <span class="n">atNames</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_type</span><span class="p">]</span>

            <span class="n">index_contact_pairs</span> <span class="o">=</span> <span class="n">tmp_dict</span>

        <span class="c1"># not sure that&#39;s the best way of dealing with that</span>
        <span class="k">if</span> <span class="n">return_contact_pairs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">index_contact_pairs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">index_contact_1</span><span class="p">,</span><span class="n">index_contact_2</span></div>

    <span class="c1"># extend the contact atoms to the residue</span>
    <span class="k">def</span> <span class="nf">_extend_contact_to_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index1</span><span class="p">,</span><span class="n">index2</span><span class="p">,</span><span class="n">only_backbone_atoms</span><span class="p">):</span>

        <span class="c1"># extract the data</span>
        <span class="n">dataA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainId,resName,resSeq&#39;</span><span class="p">,</span><span class="n">rowID</span><span class="o">=</span><span class="n">index1</span><span class="p">)</span>
        <span class="n">dataB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainId,resName,resSeq&#39;</span><span class="p">,</span><span class="n">rowID</span><span class="o">=</span><span class="n">index2</span><span class="p">)</span>

        <span class="c1"># create tuple cause we want to hash through it</span>
        <span class="c1">#dataA = list(map(lambda x: tuple(x),dataA))</span>
        <span class="c1">#dataB = list(map(lambda x: tuple(x),dataB))</span>
        <span class="n">dataA</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataA</span><span class="p">]</span>
        <span class="n">dataB</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataB</span><span class="p">]</span>

        <span class="c1"># extract uniques</span>
        <span class="n">resA</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dataA</span><span class="p">))</span>
        <span class="n">resB</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dataB</span><span class="p">))</span>

        <span class="c1"># init the list</span>
        <span class="n">index_contact_A</span><span class="p">,</span><span class="n">index_contact_B</span> <span class="o">=</span> <span class="p">[],[]</span>

        <span class="c1"># contact of chain A</span>
        <span class="k">for</span> <span class="n">resdata</span> <span class="ow">in</span> <span class="n">resA</span><span class="p">:</span>
            <span class="n">chainID</span><span class="p">,</span><span class="n">resName</span><span class="p">,</span><span class="n">resSeq</span> <span class="o">=</span> <span class="n">resdata</span>

            <span class="k">if</span> <span class="n">only_backbone_atoms</span><span class="p">:</span>
                <span class="n">index_contact_A</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chainID</span><span class="p">,</span><span class="n">resName</span><span class="o">=</span><span class="n">resName</span><span class="p">,</span><span class="n">resSeq</span><span class="o">=</span><span class="n">resSeq</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_contact_A</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chainID</span><span class="p">,</span><span class="n">resName</span><span class="o">=</span><span class="n">resName</span><span class="p">,</span><span class="n">resSeq</span><span class="o">=</span><span class="n">resSeq</span><span class="p">)</span>

        <span class="c1"># contact of chain B</span>
        <span class="k">for</span> <span class="n">resdata</span> <span class="ow">in</span> <span class="n">resB</span><span class="p">:</span>
            <span class="n">chainID</span><span class="p">,</span><span class="n">resName</span><span class="p">,</span><span class="n">resSeq</span> <span class="o">=</span> <span class="n">resdata</span>

            <span class="k">if</span> <span class="n">only_backbone_atoms</span><span class="p">:</span>
                <span class="n">index_contact_B</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chainID</span><span class="p">,</span><span class="n">resName</span><span class="o">=</span><span class="n">resName</span><span class="p">,</span><span class="n">resSeq</span><span class="o">=</span><span class="n">resSeq</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_contact_B</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span><span class="n">chainID</span><span class="o">=</span><span class="n">chainID</span><span class="p">,</span><span class="n">resName</span><span class="o">=</span><span class="n">resName</span><span class="p">,</span><span class="n">resSeq</span><span class="o">=</span><span class="n">resSeq</span><span class="p">)</span>

        <span class="c1"># make sure that we don&#39;t have double (maybe optional)</span>
        <span class="n">index_contact_A</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">index_contact_A</span><span class="p">))</span>
        <span class="n">index_contact_B</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">index_contact_B</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">index_contact_A</span><span class="p">,</span><span class="n">index_contact_B</span>


    <span class="c1"># get the contact residue</span>
<div class="viewcode-block" id="pdb2sql.get_contact_residue"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.get_contact_residue">[docs]</a>    <span class="k">def</span> <span class="nf">get_contact_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">8.5</span><span class="p">,</span><span class="n">chain1</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="n">chain2</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="n">excludeH</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">only_backbone_atoms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">return_contact_pairs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get contact residues.</span>

<span class="sd">        Args:</span>
<span class="sd">            cutoff (float): cutoff for contact atoms (default 8.5)</span>
<span class="sd">            chain1 (str): name of the first chain</span>
<span class="sd">            chain2 (str): name of the first chain</span>
<span class="sd">            only_bacbone_atoms (bool): consider only backbone atoms</span>
<span class="sd">            excludeH (bool): exclude hydrogen atoms</span>
<span class="sd">            return_contact_pairs (bool): return the contact pairs instead of contact atoms</span>


<span class="sd">        Returns:</span>
<span class="sd">            np.array: index of the contact atoms</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the contact atoms</span>
        <span class="k">if</span> <span class="n">return_contact_pairs</span><span class="p">:</span>

            <span class="c1"># declare the dict</span>
            <span class="n">residue_contact_pairs</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># get the contact atom pairs</span>
            <span class="n">atom_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contact_atoms</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span><span class="n">chain1</span><span class="o">=</span><span class="n">chain1</span><span class="p">,</span><span class="n">chain2</span><span class="o">=</span><span class="n">chain2</span><span class="p">,</span>
                                                <span class="n">only_backbone_atoms</span><span class="o">=</span><span class="n">only_backbone_atoms</span><span class="p">,</span>
                                                <span class="n">excludeH</span><span class="o">=</span><span class="n">excludeH</span><span class="p">,</span>
                                                <span class="n">return_contact_pairs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># loop over the atom pair dict</span>
            <span class="k">for</span> <span class="n">iat1</span><span class="p">,</span><span class="n">atoms2</span> <span class="ow">in</span> <span class="n">atom_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="c1"># get the res info of the current atom</span>
                <span class="n">data1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainID,resSeq,resName&#39;</span><span class="p">,</span><span class="n">rowID</span><span class="o">=</span><span class="p">[</span><span class="n">iat1</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># create a new entry in the dict if necessary</span>
                <span class="k">if</span> <span class="n">data1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">residue_contact_pairs</span><span class="p">:</span>
                    <span class="n">residue_contact_pairs</span><span class="p">[</span><span class="n">data1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                <span class="c1"># get the res info of the atom in the other chain</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainID,resSeq,resName&#39;</span><span class="p">,</span><span class="n">rowID</span><span class="o">=</span><span class="n">atoms2</span><span class="p">)</span>

                <span class="c1"># store that in the dict without double</span>
                <span class="k">for</span> <span class="n">resData</span> <span class="ow">in</span> <span class="n">data2</span><span class="p">:</span>
                    <span class="n">residue_contact_pairs</span><span class="p">[</span><span class="n">data1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">resData</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">resData</span> <span class="ow">in</span> <span class="n">residue_contact_pairs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">residue_contact_pairs</span><span class="p">[</span><span class="n">resData</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">residue_contact_pairs</span><span class="p">[</span><span class="n">resData</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">residue_contact_pairs</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># get the contact atoms</span>
            <span class="n">contact_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contact_atoms</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span><span class="n">chain1</span><span class="o">=</span><span class="n">chain1</span><span class="p">,</span><span class="n">chain2</span><span class="o">=</span><span class="n">chain2</span><span class="p">,</span><span class="n">return_contact_pairs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># get the residue info</span>
            <span class="n">data1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainID,resSeq,resName&#39;</span><span class="p">,</span><span class="n">rowID</span><span class="o">=</span><span class="n">contact_atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chainID,resSeq,resName&#39;</span><span class="p">,</span><span class="n">rowID</span><span class="o">=</span><span class="n">contact_atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># take only unique</span>
            <span class="n">residue_contact_A</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">resData</span><span class="p">)</span> <span class="k">for</span> <span class="n">resData</span> <span class="ow">in</span> <span class="n">data1</span><span class="p">]))</span>
            <span class="n">residue_contact_B</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">resData</span><span class="p">)</span> <span class="k">for</span> <span class="n">resData</span> <span class="ow">in</span> <span class="n">data2</span><span class="p">]))</span>

            <span class="k">return</span> <span class="n">residue_contact_A</span><span class="p">,</span><span class="n">residue_contact_B</span></div>


    <span class="c1">############################################################################################</span>
    <span class="c1">#</span>
    <span class="c1">#       PUT FUNCTONS AND ASSOCIATED</span>
    <span class="c1">#</span>
    <span class="c1">#           add_column()    -&gt; add a column</span>
    <span class="c1">#           update_column() -&gt; update the values of one column</span>
    <span class="c1">#           update_xyz()    -&gt; update_xyz of the pdb</span>
    <span class="c1">#           put()           -&gt; put a value in a column</span>
    <span class="c1">#</span>
    <span class="c1">###############################################################################################</span>


<div class="viewcode-block" id="pdb2sql.add_column"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.add_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">colname</span><span class="p">,</span><span class="n">coltype</span><span class="o">=</span><span class="s1">&#39;FLOAT&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Add an etra column to the ATOM table.&#39;&#39;&#39;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;ALTER TABLE ATOM ADD COLUMN &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">%s</span><span class="s2"> DEFAULT </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span><span class="n">coltype</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>
        <span class="c1">#self.conn.commit()</span>

<div class="viewcode-block" id="pdb2sql.update"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attribute</span><span class="p">,</span><span class="n">values</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># the asked keys</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># check if the column exists</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT EXISTS(SELECT </span><span class="si">{an}</span><span class="s2"> FROM ATOM)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">an</span><span class="o">=</span><span class="n">attribute</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error column </span><span class="si">%s</span><span class="s1"> not found in the database&#39;</span> <span class="o">%</span><span class="n">attribute</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># handle the multi model cases</span>
        <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nModel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iModel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nModel</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iModel</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span><span class="n">values</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># parse the attribute</span>
        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">attribute</span><span class="p">:</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="p">[</span><span class="n">attribute</span><span class="p">]</span>


        <span class="c1"># check the size</span>
        <span class="n">natt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">natt</span> <span class="o">!=</span> <span class="n">ncol</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of attribute incompatible with the number of columns in the data&#39;</span><span class="p">)</span>


        <span class="c1"># get the row ID of the selection</span>
        <span class="n">rowID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">nselect</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rowID</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nselect</span> <span class="o">!=</span> <span class="n">nrow</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of data values incompatible with the given conditions&#39;</span><span class="p">)</span>

        <span class="c1"># prepare the query</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE ATOM SET &#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="s1">&#39;=?&#39;</span><span class="p">,</span><span class="n">attribute</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">+</span> <span class="s1">&#39; WHERE rowID=?&#39;</span>


        <span class="c1"># prepare the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>

            <span class="n">tmp_data</span> <span class="o">=</span> <span class="p">[</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span> <span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>

                <span class="c1"># here the conversion of the indexes is a bit annoying</span>
                <span class="n">tmp_data</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rowID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="pdb2sql.update_column"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.update_column">[docs]</a>    <span class="k">def</span> <span class="nf">update_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">colname</span><span class="p">,</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>


        <span class="sd">&#39;&#39;&#39;Update an entire column.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">index</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">index</span><span class="p">)]</span> <span class="c1"># shouldn&#39;t that be ind+1 ?</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE ATOM SET </span><span class="si">{cn}</span><span class="s1">=? WHERE rowID=?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">data</span><span class="p">)</span></div>
        <span class="c1">#self.conn.commit()</span>

<div class="viewcode-block" id="pdb2sql.update_xyz"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.update_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">update_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xyz</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Update the xyz informatiom</span>
<span class="sd">        </span>
<span class="sd">        Update the positions of the atoms selected</span>
<span class="sd">        if index=None the position of all the atoms are changed</span>

<span class="sd">        Args:</span>
<span class="sd">            xyz (np.array): new xyz position</span>
<span class="sd">            index (None, list(int)): index of the atom to move</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">index</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">index</span><span class="p">)]</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE ATOM SET x=?, y=?, z=? WHERE rowID=?&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="pdb2sql.put"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">colname</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Update the value of the attribute with value specified with possible selection</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            colname (str)   :   must be a valid attribute name.</span>
<span class="sd">                                you can get these names via the get_colnames()</span>
<span class="sd">                                serial, name, atLoc,resName,chainID, resSeq,iCode,x,y,z,occ,temp</span>
<span class="sd">                                you can specify more than one attribute name at once e.g &#39;x,y,z&#39;</span>

<span class="sd">            keyword args    :   Several options are possible</span>
<span class="sd">                                None : put the value in the entire column</span>
<span class="sd">                                index = [0,1,2,3] in only these indexes (not serial)</span>
<span class="sd">                                where = &quot;chainID=&#39;B&#39;&quot; only for this chain</span>
<span class="sd">                                query = general SQL Query</span>

<span class="sd">        Example :</span>

<span class="sd">        &gt;&gt;&gt; db = pdb2sql(filename)</span>
<span class="sd">        &gt;&gt;&gt; db.add_column(&#39;CHARGE&#39;)</span>
<span class="sd">        &gt;&gt;&gt; db.put(&#39;CHARGE&#39;,1.25,index=[1])</span>
<span class="sd">        &gt;&gt;&gt; db.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;where&#39;</span> <span class="p">:</span> <span class="s2">&quot;String e.g &#39;chainID = &#39;A&#39;&#39;&quot;</span><span class="p">,</span>
                     <span class="s1">&#39;index&#39;</span> <span class="p">:</span> <span class="s2">&quot;Array e.g. [27,28,30]&quot;</span><span class="p">,</span>
                     <span class="s1">&#39;name&#39;</span>  <span class="p">:</span> <span class="s2">&quot;&#39;CA&#39; atome name&quot;</span><span class="p">,</span>
                     <span class="s1">&#39;query&#39;</span> <span class="p">:</span> <span class="s2">&quot;SQL query e.g. &#39;WHERE chainID=&#39;B&#39; AND resName=&#39;ASP&#39; &quot;</span><span class="p">}</span>

        <span class="c1"># the asked keys</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># if we have more than one key we kill it</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You can only specify 1 conditional statement for the pdb2sql.put function&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># check if the column exists</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT EXISTS(SELECT </span><span class="si">{an}</span><span class="s2"> FROM ATOM)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">an</span><span class="o">=</span><span class="n">colname</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error column </span><span class="si">%s</span><span class="s1"> not found in the database&#39;</span> <span class="o">%</span><span class="n">colname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>
            <span class="k">return</span>


        <span class="c1"># if we have 0 key we take the entire db</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE ATOM SET </span><span class="si">{cn}</span><span class="s1">=?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># otherwise we have only one key</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># select which key we have</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;where&#39;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE ATOM SET </span><span class="si">{cn}</span><span class="s1">=? WHERE </span><span class="si">{cond}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">colname</span><span class="p">,</span><span class="n">cond</span><span class="o">=</span><span class="n">cond</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span> <span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">value</span><span class="p">,</span><span class="n">cond</span><span class="p">])</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE ATOM SET </span><span class="si">{cn}</span><span class="s1">=? WHERE name=?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">colname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">values</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;index&#39;</span> <span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cond</span><span class="p">])</span>
            <span class="n">qm</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;?&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cond</span><span class="p">))])</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE ATOM SET </span><span class="si">{cn}</span><span class="s1">=? WHERE rowID in (</span><span class="si">{qm}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">colname</span><span class="p">,</span><span class="n">qm</span><span class="o">=</span><span class="n">qm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">values</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;query&#39;</span> <span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE ATOM SET </span><span class="si">{cn}</span><span class="s1">=? </span><span class="si">{c1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="o">=</span><span class="n">colname</span><span class="p">,</span><span class="n">c1</span><span class="o">=</span><span class="n">cond</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error arguments </span><span class="si">%s</span><span class="s1"> not supported in pdb2sql.get()</span><span class="se">\n</span><span class="s1">Options are:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">posskey</span><span class="p">,</span><span class="n">possvalue</span> <span class="ow">in</span> <span class="n">arguments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">posskey</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">possvalue</span><span class="p">)</span>
            <span class="k">return</span></div>



    <span class="c1">############################################################################################</span>
    <span class="c1">#</span>
    <span class="c1">#       COMMIT, EXPORT, CLOSE FUNCTIONS</span>
    <span class="c1">#</span>
    <span class="c1">###############################################################################################</span>

    <span class="c1"># comit changes</span>
<div class="viewcode-block" id="pdb2sql.commit"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

    <span class="c1"># export to pdb file</span>
<div class="viewcode-block" id="pdb2sql.exportpdb"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.exportpdb">[docs]</a>    <span class="k">def</span> <span class="nf">exportpdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Export a PDB file with kwargs selection</span>
<span class="sd">        not pretty so far but functional</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># get the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># write each line</span>
        <span class="c1"># the PDB format is pretty strict</span>
        <span class="c1"># http://www.wwpdb.org/documentation/file-format-content/format33/sect9.html#ATOM</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;ATOM  &#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:&gt;5}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>    <span class="c1"># serial</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:^4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>    <span class="c1"># name</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:&gt;1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>    <span class="c1"># altLoc</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:&gt;3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>    <span class="c1">#resname</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:&gt;1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>    <span class="c1"># chainID</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:&gt;4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>    <span class="c1"># resSeq</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:&gt;1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>    <span class="c1"># iCODE</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;   &#39;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{: 8.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="c1">#x</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{: 8.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="c1">#y</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{: 8.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="c1">#z</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{: 6.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>    <span class="c1"># occ</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{: 6.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>    <span class="c1"># temp</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># close</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="c1"># close the database</span>
<div class="viewcode-block" id="pdb2sql.close"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rmdb</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">rmdb</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlfile</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1">############################################################################</span>
    <span class="c1">#</span>
    <span class="c1"># Transform the position of the molecule</span>
    <span class="c1">#</span>
    <span class="c1">##############################################################################</span>


<div class="viewcode-block" id="pdb2sql.translation"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.translation">[docs]</a>    <span class="k">def</span> <span class="nf">translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vect</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x,y,z&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">+=</span> <span class="n">vect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;x,y,z&#39;</span><span class="p">,</span><span class="n">xyz</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="pdb2sql.rotation_around_axis"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.rotation_around_axis">[docs]</a>    <span class="k">def</span> <span class="nf">rotation_around_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x,y,z&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># get the data</span>
        <span class="n">ct</span><span class="p">,</span><span class="n">st</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">ux</span><span class="p">,</span><span class="n">uy</span><span class="p">,</span><span class="n">uz</span> <span class="o">=</span> <span class="n">axis</span>

        <span class="c1"># get the center of the molecule</span>
        <span class="n">xyz0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># definition of the rotation matrix</span>
        <span class="c1"># see https://en.wikipedia.org/wiki/Rotation_matrix</span>
        <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="n">ct</span> <span class="o">+</span> <span class="n">ux</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ct</span><span class="p">),</span>         <span class="n">ux</span><span class="o">*</span><span class="n">uy</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ct</span><span class="p">)</span> <span class="o">-</span> <span class="n">uz</span><span class="o">*</span><span class="n">st</span><span class="p">,</span>       <span class="n">ux</span><span class="o">*</span><span class="n">uz</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="n">uy</span><span class="o">*</span><span class="n">st</span><span class="p">],</span>
        <span class="p">[</span><span class="n">uy</span><span class="o">*</span><span class="n">ux</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="n">uz</span><span class="o">*</span><span class="n">st</span><span class="p">,</span>      <span class="n">ct</span> <span class="o">+</span> <span class="n">uy</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ct</span><span class="p">),</span>          <span class="n">uy</span><span class="o">*</span><span class="n">uz</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ct</span><span class="p">)</span> <span class="o">-</span> <span class="n">ux</span><span class="o">*</span><span class="n">st</span><span class="p">],</span>
        <span class="p">[</span><span class="n">uz</span><span class="o">*</span><span class="n">ux</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ct</span><span class="p">)</span> <span class="o">-</span> <span class="n">uy</span><span class="o">*</span><span class="n">st</span><span class="p">,</span>      <span class="n">uz</span><span class="o">*</span><span class="n">uy</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ct</span><span class="p">)</span> <span class="o">+</span> <span class="n">ux</span><span class="o">*</span><span class="n">st</span><span class="p">,</span>       <span class="n">ct</span> <span class="o">+</span> <span class="n">uz</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ct</span><span class="p">)</span>   <span class="p">]])</span>

        <span class="c1"># apply the rotation</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">,(</span><span class="n">xyz</span><span class="o">-</span><span class="n">xyz0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">xyz0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;x,y,z&#39;</span><span class="p">,</span><span class="n">xyz</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xyz0</span></div>

<div class="viewcode-block" id="pdb2sql.rotation_euler"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.rotation_euler">[docs]</a>    <span class="k">def</span> <span class="nf">rotation_euler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">gamma</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x,y,z&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># precomte the trig</span>
        <span class="n">ca</span><span class="p">,</span><span class="n">sa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">cb</span><span class="p">,</span><span class="n">sb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">cg</span><span class="p">,</span><span class="n">sg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>


        <span class="c1"># get the center of the molecule</span>
        <span class="n">xyz0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># rotation matrices</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">ca</span><span class="p">,</span><span class="o">-</span><span class="n">sa</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">sa</span><span class="p">,</span><span class="n">ca</span><span class="p">]])</span>
        <span class="n">ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">sb</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="o">-</span><span class="n">sb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cb</span><span class="p">]])</span>
        <span class="n">rz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cg</span><span class="p">,</span><span class="o">-</span><span class="n">sg</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="n">sg</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ry</span><span class="p">,</span><span class="n">rz</span><span class="p">))</span>

        <span class="c1"># apply the rotation</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">,(</span><span class="n">xyz</span><span class="o">-</span><span class="n">xyz0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">xyz0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;x,y,z&#39;</span><span class="p">,</span><span class="n">xyz</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="pdb2sql.rotation_matrix"><a class="viewcode-back" href="../../../deeprank.tools.html#deeprank.tools.pdb2sql.pdb2sql.rotation_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">rotation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rot_mat</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x,y,z&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
            <span class="n">xyz0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">,(</span><span class="n">xyz</span><span class="o">-</span><span class="n">xyz0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">xyz0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rot_mat</span><span class="p">,(</span><span class="n">xyz</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;x,y,z&#39;</span><span class="p">,</span><span class="n">xyz</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="c1"># create the sql</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">pdb2sql</span><span class="p">(</span><span class="s1">&#39;1AK4_100w.pdb&#39;</span><span class="p">)</span>

    <span class="c1"># print the database</span>
    <span class="n">db</span><span class="o">.</span><span class="n">prettyprint</span><span class="p">()</span>

    <span class="c1"># get the names of the columns</span>
    <span class="n">db</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>

    <span class="c1"># extract the xyz position of the atoms with name CB</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>

    <span class="n">xyz</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span><span class="n">where</span><span class="o">=</span><span class="s2">&quot;resName=&#39;VAL&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">,</span><span class="s1">&#39;FLOAT&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">prettyprint</span><span class="p">()</span>

    <span class="n">db</span><span class="o">.</span><span class="n">exportpdb</span><span class="p">(</span><span class="s1">&#39;chainA.pdb&#39;</span><span class="p">,</span><span class="n">where</span><span class="o">=</span><span class="s2">&quot;chainID=&#39;A&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># close the database</span>
    <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial : Data Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial_deeplearning.html">Tutorial : Deep learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advTuto.html">Advanced Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Documentation.html">Documentation</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">DeepRank 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Nicolas Renaud.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.6.
    </div>
  </body>
</html>